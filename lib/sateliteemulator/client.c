#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <netdb.h> 
#include <string.h>
#include <stdlib.h>
#include <ctype.h>
#include <unistd.h>

void error(char *msg)
{
    perror(msg);
    exit(1);
}

int main(int argc, char *argv[])
{
	int sockfd, portno, n;
	char c;
	struct sockaddr_in serv_addr;
	struct hostent *server;
	int trace;
	int msglen=0;
	char buffer[1024];
	if (argc < 4) {
	fprintf(stderr,"usage %s hostname port trace\n", argv[0]);
	exit(0);
	}
	portno = atoi(argv[2]);
	sockfd = socket(AF_INET, SOCK_STREAM, 0);
	if (sockfd < 0) 
		error("ERROR opening socket");
	server = gethostbyname(argv[1]);
	if (server == NULL) {
	fprintf(stderr,"ERROR, no such host\n");
	exit(0);
	}
	trace = atoi(argv[3]);
	
	bzero((char *) &serv_addr, sizeof(serv_addr));
	serv_addr.sin_family = AF_INET;
	bcopy((char *)server->h_addr, (char *)&serv_addr.sin_addr.s_addr, server->h_length);
	serv_addr.sin_port = htons(portno);
	if (connect(sockfd,(struct sockaddr*)&serv_addr,sizeof(serv_addr)) < 0) 
	error("ERROR connecting");

	while(1){    
		msglen=0;
		trace++;
		bzero(buffer,1024);
		printf("Escoja el tipo de mensaje:\n");
		printf("a) Alignet 200\n");
		printf("b) Alignet 200 Recurrente\n");
		printf("c) Alignet 400\n");
		printf("d) CML Adm 200 Card Order\n");
		printf("e) CML Adm 201 Card Activation\n");
		printf("f) CML Adm 216 Card Update\n");
		printf("g) CML Adm 223 Card Inquiry\n");
		printf("h) CML Adm 224 Tracking Status\n");
		printf("i) CML Adm 220 Add Account\n");
		printf("j) CML Adm 227 Account Inquiry --> NO HAY\n");
		printf("k) CML Adm 221 Remove Account --> NO HAY\n");
		printf("l) CML Adm 204 Add Card-Acct.\n");
		printf("m) CML VALIDA PIN\n");
		printf("n) CML Adm 203 Inquiry Card-Acct.\n");
		printf("o) CNP Cambio de Clave\n");
		printf("p) CNP Validacion de PIN\n");
		printf("q) CML 810\n");
		printf("r) 9500 HSBC\n");
		printf("1) Merchandise return\n");
		printf("-) Extorno con motivo\n");
		printf("z) Salir\n>>");

		switch(tolower(getc(stdin))){
		case '-':
			trace--; // useful when a previous 200 msg was sent
			sprintf(buffer, "03760400D03E60018CE180100000004000000004164012001037141112000000000100%06d18022512021212000072991880652991406493823933418%06d0280162503    002003880200000BNCE PRUEBAS             SAN JOSE     CR006*0000184001051      050200%06d1202165144000065299140000649382311201CB000000000000000000000000000000000000010582454120157200448345410000000000 03200000000000000000000000000000000",trace, trace, trace);
			break;
		case '1':
			sprintf(buffer, "03220200D03E600180E180100000000000000004164012001037141112000000007769%06d16514412021212000072991880652991406493823MCRETURN002003880200000BNCE PRUEBAS             SAN JOSE     CR006*0000184001051      0511801CB000000000000000000000000000000000700010489376624134392275037661062E78D2B11 123 03200000000000000000000000000000000" , trace);
			break;
		case 'a':
			sprintf(buffer, "03220200D03E600180E180100000000000000004164012001037141112000000007769%06d16514412021212000072991880652991406493823        002003880200000BNCE PRUEBAS             SAN JOSE     CR006*0000184001051      0511801CB000000000000000000000000000000000700010489376624134392275037661062E78D2B11 123 03200000000000000000000000000000000" , trace);
			/*sprintf(buffer, "03220200D03E600180E180100000000000000004164859510000000036000000007769%06d16514412021212000072991880652991406493823        002003880200000BNCE PRUEBAS             SAN JOSE     CR006*0000184001051      0511801CB000000000000000000000000000000000700010489376624134392275037661062E78D2B11 123 03200000000000000000000000000000000", trace);*/
		//sprintf(buffer, "03080200D03E600180E180100000000000000004164859510000000036000000007769%06d16514412021212000072991880652991406493823        002003880200000BNCE PRUEBAS             SAN JOSE     CR006*0000184001051      0510401CA100000000000000000000000000000000700010489376624134392275037661062E78D2B11 123 032000000000000000000", trace);
		//sprintf(buffer, "03220200D03E600180E180100000000000000004164859510000000036000000007769%06d16514412021212000072991880652991406493823        002003880200000BNCE PRUEBAS             SAN JOSE     CR006*0000184001051      0511801CB000000000000000000000000000000000700010489376624134392275037661062E78D2B11 123 03200000000000000000000000000000000", trace);
     // sprintf(buffer, "03220200D03E600180E180100000000000000004164859510000000036000000007769%06d16514412021212000072991880652991406493823        002003880200000BNCE PRUEBAS             SAN JOSE     CR006*0000184001051      0511801CB00000000000000000000000000000000000002081959978451998787845997000000000011 123 03200000000000000000000000000000000", trace);
			break;
		case '0':
			sprintf(buffer, "03220200D03E600180E180100000000000000004164263140000000016000000007769%06d16514403241212000056912180652991406456358        332976         AUTORIZACIONES 3D SECURE CUENCA       EC006*0000184001051      0511801CB000000000000000000000000000000000000020819599784519987878459970000000000      R03200000000000000000000000000000000", trace);
			break;
		case 'b':
			sprintf(buffer, "02560200D03E600180E080100000000000000004164263140000000016000000000100%06d15024509090912000031271880652991406455337        102612000000000TACA                     SAN SALVADOR CR84001050      06061717200409281106196710800020569307755452486168130770000000000R", trace);
			break;
		case 'c':
			trace--; // useful when a previous 200 msg was sent
			sprintf(buffer, "03760400D03E60018CE180100000004000000004164012001037141112000000000100%06d18022512021212000072991880652991406493823933418%06d028016        002003880200000BNCE PRUEBAS             SAN JOSE     CR006*0000184001051      050200%06d1202165144000065299140000649382311201CB000000000000000000000000000000000000010582454120157200448345410000000000 03200000000000000000000000000000000",trace, trace, trace);
			/*sprintf(buffer, "03760400D03E60018CE180100000004000000004164859510000000036000000000100%06d18022512021212000072991880652991406493823933418%06d028016        002003880200000BNCE PRUEBAS             SAN JOSE     CR006*0000184001051      050200%06d1202165144000065299140000649382311201CB000000000000000000000000000000000000010582454120157200448345410000000000 03200000000000000000000000000000000", trace-1, trace-1, trace-1);
                          sprintf(buffer, "03160400D03E60018CE080100000004000000004164263140000000016000000000100%06d18341204010812000031271880652991406455337429518%06d666666        102612000000000TACA                     SAN SALVADOR CR84001050      060200%06d10211502450000052991400000455337061717200409281106196710800020569307755452486168130770000000000R", trace-1, trace-1, trace-1); */
			break;
		case 'd':
      //                    strcpy(buffer, "0350030244082200000000120819170649010001440822440822  0200040819INNOMINADA     INNOMINADA     INNOMINADA          CML                      CENTRO                   LIMA           LIMA           L01       3654677       01M900101S000000001                                        INNOMINADA                O00000408230808040823150718                        ");
			strcpy(buffer, "0350030249249101000002100502190912000021492491492491000200050502INNOMINADA     INNOMINADA     INNOMINADA          CAJA NOR PERU            CAJA NOR PERU            LIMA           LIMA                     299000        01M900101S000000000  99999999                              INNOMINADA                 0000000000    000000000000000000000000000000000000");
			break;
		case 'e':
			strcpy(buffer, "0350030244082200000000120811171523010012440822440822  0201040811INNOMINADA     INNOMINADA     INNOMINADA     Srta CLL. LOPEZ DE AYALA 1412                          SAN BORJA      LIMA                     98382107      01F380512S01       LE22315220                              NADIA COSSIO L            A00000408110808040811151500040811190825            ");
			break;
		case 'f':
			strcpy(buffer, "0350030244082200000000200812145749010005440822440822  0216040812ALBERTO CARLOS CASELLA        LARA           Sr   CLL.AUGUSTO OLAECHEA 280 DPTO.-B- URB.EL ROSEDAL  MIRAFLORES     LIMA                     4477227       01M171114S000000001LE08773498                              ALBERTO CASELLA L         A00000408251308040825160612040825160612            ");
			break;
		case 'g':
			strcpy(buffer, "0350030244082200000000200812145817010008440822440822  0223                                                                                                                                                                                                                                                                                                        ");
			break;
		case 'h':
			strcpy(buffer, "0350030244082200000000200812145831010009440822440822  0224                                                                                                                                                                                                                                                                                                        ");
			break;
		case 'i':
			strcpy(buffer, "0086030244082200000000200812145855010011440822440822  022001322000092720440822     01 1840");
			break;
		case 'j':
			sprintf(buffer, "02560200D03E600180E080100000000000000004164859510000000028000000000100%06d15024510210512000031271880652991406455337        102612000000000TACA                     SAN SALVADOR CR84001050      06061000000000000000000000800020569307755452486168130770000000000 ", trace);
			break;
		case 'k':
			sprintf(buffer, "02560200D03E600180E080100000000000000004164859510000000028000000000100%06d15024510210512000031271880652991406455337        102612000000000TACA                     SAN SALVADOR CR84001050      06061000000000000000000000800020569307755452486168130770000000000R", trace);
			break;
		case 'l':
			strcpy(buffer, "0125030244082200000000200812145856010013440822440822  020412321000000701440822     01 NOk                            604YYNYY");
			break;
		case 'm':
		  //                    strcpy(buffer, "006895004408220000038111040002091304121600000236VP04201009472C1F0E65E807");
	 //     sprintf(buffer, "0200f23cc481a8e1900000000000100000041642214210000353558600000000000000000115163740%06d1637400115101101156010901640669691206422142374221421000035355=10111011314232600000050090002000        SCOTIABANK 11  TARJETA DE CREDITO Y DEBITO             000604455B3DA480DBCCEC06696912058P           ! 06      1                116B5D87A6E7A74BCC2", trace);
	   //   sprintf(buffer, "0200f23cc481a8e1900000000000100000041642214210000353558600000000000000000115163740%06d1637400115101101156010901640669691206422142374221421000035355=10111011314232600000050090002000        SCOTIABANK 11  TARJETA DE CREDITO Y DEBITO             000604455B3DA480DBCCEC06696912058P           ! 06      1                116B5D87A6E7A74BCC2", trace);
			sprintf(buffer, "0200f23cc48168e190000000000016000004165275569900003394860086000000000000041716170243925816170204171906000060100216406696935165275569900003394375275569900003394=19061011977153500000439258161702TE      NV035                                                PE00084038042CEDBF9B72470669693528              457044        00074&           ! 0600074 1                11638042CEDBF9B724738042CEDBF9B7247");

			break;
		case 'n':
			strcpy(buffer, "0125030244082200000001370428210804010018440822440822  0203102012321000000701440822     01 NOk                            604YYNYY");
			break;
		case 'o':
			*buffer=0x00;
			*(buffer+1)=0x7F;
			sprintf(buffer+2, "95004545120000000067860000%06d18490910254545120000000067=1609126194544910000000000001CP04NONE360DB557CEDADED1E0557B1814FFF55E", trace);
			//      sprintf(buffer+2, "95004545120000000067860000%06d18490910264545120000000067=1609126108504910000000000001CP04NONE360DB557CEDADED1E0557B1814FFF55E", trace);
			msglen = 129;
			break;
		case 'p':
			*buffer=0x00;
			*(buffer+1)=0x7F;
			//      sprintf(buffer, "012795004924910100015275980000%06d18490901174924910100015275=0910126108504910000000000001VP0440166E8BEBBEC2615BE20000000000000000", trace);
			sprintf(buffer+2, "95004545120000000067980000%06d18490910264545120000000067=1609126194544910000000000001VP04NONE360DB557CEDADED10000000000000000", trace);
			msglen = 129;
			break;
		case 'q':
			strcpy(buffer, "016008100000000000000000000000000000000000440822000000000003090000000000                                        0000000000000000000000301000000000000000000000000000");
			break;
			case 'r':
			*buffer=0x0;
			//    *(buffer+1)=0x7f;
			*(buffer+1)=0x92;
			//    sprintf(buffer+2, "95004473150100037368980000%06d10350010174473150100037368=1212126142280830005012345678VP04NONE123456789012345600000000000000000000000100010102431", trace);
			//    sprintf(buffer+2, "95004924910101988884980000%06d17582004264924910101988884=1604126102856290000000000000VP04NONE816118D660754C830000000000000000", trace);
			sprintf(buffer+2, "95004473159900088844980000%06d10441302054473159900088844=1909226108796470000025109723VP04NONEEC4A375E9E3706EA00000000000000000000010411044130205", trace);
			//      msglen = 129;
			msglen = 148;
			break;
		case 's':
			*buffer=0x0;
			*(buffer+1)=0x92;
			sprintf(buffer+2, "0200E03C848122A010000400000010000004164408220000464275860000%06d1643031104121011040216406440822374408220000464275=121012617610449000000000000425PIN PAD CAJA METROPOLITANA            PEB93911F88DB1ED4900006440822074& 0000100062! 0600053 11               1166D19E8B08654C2EE6D19E8B08654C2EE", trace);
			msglen = 292;
			break;
		case 't': /* Cambio de clave, pin errado */
			*buffer=0x0;
			*(buffer+1)=0x92;

			//sprintf(buffer+2, "9500447315990008884486000000104615511102054473159900088844=1909226108796470000025170904CP04NONEEC4A375E9E3706EA0000D8CA5D6A9CED8530010461551110205", trace);
			sprintf(buffer+2, "95004473159900088844860000%06d17461002064473159900088844=1909226108796470000025170904CP04NONEEC4A375E9E3706EA0000D8CA5D6A9CED8531234567890ABCDEF", trace);
			//      sprintf(buffer, "014695004408220000464325860000%06d18334812054408220000464325=12121261    4800000000000425CP04    D7EFEA6C134C14DE000ECD4984E70E14FE21192977         ", trace);
			msglen = 148;
			break;
		case 'u':
			*buffer=0x1;
			*(buffer+1)=0x0D;
			sprintf(buffer+2, "0200f23cc481a8e1800000000000100000001644731100000853210190000000000300001106082918%06d0829181106111011056010902640644731506447311374473110000085321=1110101122771790000000000000000005028426               MORRO SOLAR,1030,LIMA LIMA              010920600000 60406447315", trace);
			msglen = 269;
			break;
		case 'v':
		  *buffer=0x00;
		  *(buffer+1)=(unsigned char)0x93;
		  /*
		   *(buffer+1)=0x00;
		   *buffer=0x93;
		   */
		  /*
		B0000032042615301;029020114400;
		060,780,868,595,231,392,431,859,011,589,
		865,304,109,598,257,230,783,620,333,072,
		290,785,299,944,119,241,751,516,528,417,
		413,065,298,536,725,554,912,892,539,629,
		534,770,526,719,037,268,746,944,748,298,
		575,929,905,171,105,302,208,722,320,320,

		A	B	C	D	E	F	G	H	I	J
		1	367	133	133	562	398	647	737	673	019	684
		2	888	891	610	196	551	578	528	816	318	033
		3	676	551	909	960	250	038	510	164	348	821
		4	276	890	695	985	982	837	502	235	438	551
		5	882	224	473	649	238	272	882	111	801	686
		6	975	754	383	138	875	981	328	806	718	802
		7	562	721	674	730	184	111	428	325	493	283
		8	552	237	321	591	638	226	566	082	815	941
		649020120014
		  */
		  // F4: 554, Tarjeta: 029020114400
		  //      sprintf(buffer+2, "95004261530000000000980080%06d18350002250000000000000000000000000000000000000HB012010VC05C69055EECB9196EE456530000000000000000", trace);
		  // D431846444D28E86
		  //      sprintf(buffer+2, "95004027010000000000980080%06d13025412020000000000000000000000000000000000000TERM0001VC05%2.2s367%16.16s0000000000000000", trace, argv[4], argv[5]);
		  sprintf(buffer+2, "95004408220000000000980080%06d1217190424000000000000000000000000000000000000000000103VC05B23339BCD170215D9DB3000000000000000000002876860         ", trace);
		  msglen = 149;
		  //			msglen = 256 * (unsigned int)(*buffer) + (unsigned int)(*(buffer+1)) + 2;
		  break;
		case 'w': // mensaje 800 de SodexoW
		  *buffer=0x00;
		  *(buffer+1)=0x3F;
		  sprintf(buffer+2, "080082200000000000000400000010000000050707412907412930106696955");
		  msglen = 65;
		  break;
		case 'x': // Cambio de clave SodexoW
		  *buffer=0x01;
		  *(buffer+1)=0x5F;
		  //					sprintf(buffer+2, "0200F23EC48128E0900000000000160000041652955599000000338600000000000000000505151515%06d151515050514070000000000002106406696955375295559900000033=140752010000000000000500700030  QPADEV00SODEXO WEB     TARJETA PREPAGO SODEXO                PE604A8647A0FF5DB8D3B066969550000074& 0000100062! 0600053 11               116A8647A0FF5DB8D3BA8647A0FF5DB8D3B", trace);
		  //			sprintf(buffer+2, "0200F23EC48128E0900000000000160000041652955599000000908600000000000000000618164407%06d164407061814100000000000002106406696955375295559900000090=14105201000000000000000000000000QPADEV00SODEXO WEB     TARJETA PREPAGO SODEXO                PE60406E1CD533E34031A064570440000074& 0000100062! 0600053 11               11620A0946D5619D59420A0946D5619D594", trace);
		  sprintf(buffer+2, "0200F23EC48128E0900000000000160000041652955599000000908600000000000000000618164407%06d164407061814100000000000002106406696955375295559900000090=14105201000000000000000000000000QPADEV00SODEXO WEB     TARJETA PREPAGO SODEXO                PE60406E1CD533E34031A064570440000074&0000100062!0600053 11                 11620A0946D5619D59420A0946D5619D594", trace);
		  msglen = 353;
		  break;
		case 'y': // Consulta SodexoW
		  *buffer=0x01;
		  *(buffer+1)=0x13;
		  sprintf(buffer+2, "0200F23EC48128E0900000000000160000041652955599000000823100000000000000000503163523%06d163523050314070000000000002106406696955375295559900000082=14075201000000000000000000000000QPADEV00SODEXO WEB     TARJETA PREPAGO SODEXO                PE6040000000000000000066969550000000", trace);
		  //sprintf(buffer+2, "0200f23ec48108e0900000000000160000001652955599000000903100000000000000000609194812%06d1948120609140700000000000021064066969551852955599000000901407000000000000QPADEV00SODEXO WEB TARJETA PREPAGO SODEXO PE60400000000000018680645704400000000000000001111", trace);
		  msglen = 277;
		  break;
		case '9': // mensaje 800 de HSBC
		  *buffer=0x00;
		  *(buffer+1)=0x92;
		  sprintf(buffer+2, "08000000000000000000000000123456151617052600000000000000000000000000000000000008888888800000000000000000000000030100000000000000001234123412341234");
		  msglen = 148;
		  break;
		case '8': // Validacion de clave de jPAU
		  *buffer=0x00;
		  *(buffer+1)=0xa4;
		  sprintf(buffer+2, "0200E0380001208110000400000000000004164261540000000225950000267827100255122906426154374261540000000225=12091201746647400000V0010008008VP04NONE749AA01D690D8A2A000000");
		  msglen = 166;
		  break;
		case '7': // Validacion de clave del jPAU sin track2
		  *buffer=0x00;
		  *(buffer+1)=0x7f;
		  sprintf(buffer+2, "0200E038000120811000040000000000000416426154000000022595000002216909084712290642615400AP01NEGR008VP04NONE749AA01D690D8A2A000000");
		  msglen = 129;
		  break;
		case '6': // Consulta de Tarjetas Peruanas
		  *buffer=0x00;
		  *(buffer+1)=0xda;
		  //      sprintf(buffer+2, "0200F23CC48148E1800000000000160000001648948699039999923100000000000000000421111808%06d111808042121040000000021014066969570021091900000188888888NK000000000002                                         000604066969570000", trace);
		  sprintf(buffer+2, "0200F23CC48148E1800000000000160000001648948600000100153900000000000000000421111808%06d111808042121040000000021014066969570021091900000188888888NK000000000002                                         000604066969570000", trace);
		  msglen = 220;
		  break;
		case '5': // Recarga de tarjetas peruanas online
		  *buffer=0x01;
		  *(buffer+1)=0x2f;
		  sprintf(buffer+2, "0200f23cc48148e0900000000000160000001648948600000201138700000000000040001201132828%06d1845101201130800000000210140669695716489486000002011312141800000388888888NK000000000002                                         604CA9311D50A6F30570648948628              696999        280000000008    489486        ", trace);
		  //  sprintf(buffer+2, "0200f23cc48148e0900000000000160000001967458168197287847208900200000000040001201132828%06d1845101201110800000000210140669695716489486000002011312141800000388888888NK000000000002                                         604CA9311D50A6F30570648948628              696999        28              500000        ", trace);
		  msglen = 305;
		  break;
		case '4': // Recarga de tarjetas peruanas online con cargo a 696957
		  *buffer=0x01;
		  *(buffer+1)=0x2f;
		  //      sprintf(buffer+2, "0200f23cc48148e0900000000000160000001648948699039999928700000000004000001206132828%06d1845101206120800000000210140669695716489486000002011312141800000388888888NK000000000002                                         604CA9311D50A6F30570648948628              696999        280000000008    489486        ", trace);
		  sprintf(buffer+2, "0200f23cc48148e0900000000000160000001648948699039999928700000000010000001206132828%06d1845101206120800000000210140669695716489486000002011312141800000388888888NK000000000002                                         604CA9311D50A6F30570648948628              696999        280000000008    489486        ", trace);
		  //      sprintf(buffer+2, "0200f23cc48148e0900000000000160000001669699900000000088700000000010000001206132828%06d1845101206120800000000210140669695716489486000002011312141800000388888888NK000000000002                                         604CA9311D50A6F30570648948628              696999        280000000008    489486        ", trace);
		  //      sprintf(buffer+2, "0200f23cc48148e0900000000000160000001669695700000000088700000000010000001206132828%06d1845101206120800000000210140669695716489486000002011312141800000388888888NK000000000002                                         604CA9311D50A6F30570648948628              696999        280000000008    489486        ", trace);
		  msglen = 305;
		  break;
		case '3': // Recarga de tarjetas peruanas online con cargo a 696957
		  *buffer=0x01;
		  *(buffer+1)=0x2f;
		  sprintf(buffer+2, "0200f23cc48148e0900000000000160000001669692300000000088700000001004000000810132828%06d1845100810110800000000210140669695716489486000002011312141800000388888888NK000000000002                                         604CA9311D50A6F30570648948628              696999        280000000008    489486        ", trace);
		  msglen = 305;
		  break;
		case '2': // Consulta EDENRED
		  *buffer=0x00;
		  *(buffer+1)=0xd5;
		  sprintf(buffer+2, "0200f23ec48108e0800000000000100000001648635200000000133100000000000000000722193555%06d193555072213120722072200000006406696948000000000000QPADEV00ACCOR WEB      TARJETA PREPAGO ACCOR                 PE60406457044", trace);
		  msglen = 215;
		  break;
		case 'z':
		  exit(0);
		default:
		  printf("Opcion desconocida\n");
		  continue;
    }

		while ((c=fgetc(stdin))!= '\n' && c != EOF);

		if(!msglen){
		  msglen=strlen(buffer);
		}

		printf("msglen: %d %0x %0x %0x\n", msglen,buffer[0], buffer[1], buffer[2]);
		n = write(sockfd,buffer,msglen);
		if (n < 0) {
		  error("ERROR writing to socket");
		}
		printf("Wrote: '%s'\n", buffer);
	}
	return 0;
}
